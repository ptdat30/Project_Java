<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Đăng Nhập</title>
    <link rel="stylesheet" href="assets/css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div class="login-container">
    <h2>Đăng nhập</h2>
    <p class="signup-link">
        Bạn chưa có tài khoản? <a href="sign_up.html">Tạo tài khoản ngay</a>
    </p>

    <form id="loginForm" action="/login" method="POST">
        <div class="input-group">
            <label for="email">Tài khoản hoặc email</label>
            <input type="text" id="email" name="usernameOrEmail" required>
        </div>

        <div class="input-group">
            <label for="password">Mật khẩu</label>
            <div class="password-wrapper">
                <input type="password" id="password" name="password" required>
                <i class="fas fa-eye-slash toggle-password"></i>
            </div>
        </div>

        <div class="options">
            <div class="remember-me">
                <input type="checkbox" id="remember" name="rememberMe">
                <label for="remember">Duy trì đăng nhập</label>
            </div>
            <a href="reset_pass_1.html" class="forgot-password">Quên mật khẩu?</a>
        </div>

        <button type="submit" class="btn btn-login">Đăng nhập</button>
    </form>

    <div id="apiMessage" class="api-message"></div>

    <div class="divider"></div>

    <p class="social-login-text">Hoặc bạn có thể đăng nhập với Google</p>
    <div class="social-login-btn-wrapper">
        <button class="btn btn-google" onclick="location.href='http://localhost:8080/oauth2/authorization/google'">
            <img src="https://img.icons8.com/color/16/000000/google-logo.png" alt="Google logo"> Tiếp tục với Google
        </button>
    </div>
</div>
</body>
</html>
<script>
    // assets/js/login.js

    // --- Hỗ trợ UI: Ẩn/hiện mật khẩu ---
    function setupPasswordToggle() {
        const togglePassword = document.querySelector('.toggle-password');
        const passwordInput = document.getElementById('password');

        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function() {
                // Chuyển đổi thuộc tính type giữa 'password' và 'text'
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Chuyển đổi icon mắt
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
            });
        }
    }

    // --- Xử lý hiển thị thông báo API ---
    function displayApiMessage(message, isError = false) {
        const messageArea = document.getElementById('apiMessage');
        if (messageArea) {
            messageArea.innerText = message;
            if (isError) {
                messageArea.style.color = 'red'; // Màu đỏ cho lỗi
            } else {
                messageArea.style.color = 'green'; // Màu xanh cho thành công
            }
            messageArea.style.display = 'block'; // Đảm bảo phần tử hiển thị
        }
    }

    // --- Gửi yêu cầu đăng nhập lên API ---
    async function handleLoginSubmit(event) {
        event.preventDefault(); // Ngăn chặn form gửi đi theo cách truyền thống

        const form = event.target;
        const formData = new FormData(form); // Lấy dữ liệu từ form

        // Chuyển FormData thành đối tượng JSON
        const data = {};
        formData.forEach((value, key) => (data[key] = value));

        try {
            const response = await fetch(form.action, { // Sử dụng action của form làm URL
                method: form.method, // Sử dụng method của form (POST)
                headers: {
                    'Content-Type': 'application/json', // Báo cho server biết chúng ta gửi JSON
                },
                body: JSON.stringify(data), // Chuyển đối tượng JS sang JSON string
            });

            if (!response.ok) {
                // Nếu trạng thái HTTP không phải 2xx (ví dụ: 401 Unauthorized, 400 Bad Request)
                const errorData = await response.json().catch(() => response.text()); // Cố gắng đọc JSON, nếu không đọc văn bản
                const errorMessage = typeof errorData === 'string' ? errorData : errorData.message || 'Đăng nhập không thành công.';
                throw new Error(errorMessage);
            }

            // Đọc phản hồi thành công
            const responseData = await response.json(); // Mong đợi JSON từ server

            displayApiMessage(responseData.message || 'Đăng nhập thành công!', false);

            // Chuyển hướng người dùng sau khi đăng nhập thành công
            // Thay đổi '/home' bằng URL trang chính của bạn sau khi đăng nhập
            setTimeout(() => {
                window.location.href = '/home';
            }, 1500); // Chuyển hướng sau 1.5 giây để người dùng đọc thông báo

        } catch (error) {
            console.error('Lỗi đăng nhập:', error);
            displayApiMessage(error.message || 'Có lỗi xảy ra trong quá trình đăng nhập. Vui lòng thử lại.', true);
        }
    }

    // --- Khởi tạo các sự kiện khi DOM đã sẵn sàng ---
    document.addEventListener('DOMContentLoaded', () => {
        // Thiết lập chức năng ẩn/hiện mật khẩu
        setupPasswordToggle();

        // Lắng nghe sự kiện submit của form đăng nhập
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', handleLoginSubmit);
        }
    });

    // Chú ý: Phần code Fetch API ban đầu của bạn chỉ là một GET request đến /login
    // và không liên quan trực tiếp đến việc gửi dữ liệu form đăng nhập.
    // Tôi đã loại bỏ phần đó và thay thế bằng logic gửi form POST.
    // Nếu bạn vẫn cần gọi GET /login khi trang tải, bạn có thể tạo một hàm riêng.
    // Tuy nhiên, với một trang đăng nhập, việc gọi GET /login khi tải trang thường không cần thiết.
</script>